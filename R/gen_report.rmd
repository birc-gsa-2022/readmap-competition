---
title: "Performance report"
output: md_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
```

```{r helpers}
lang <- function(proj) {
  proj |> 
    str_to_lower() |>
    when(
      str_starts(., "python")    ~ "Python",
      str_starts(., "go")        ~ "Go",
      str_starts(., "c-cmake")   ~ "C",
      ~ "Unknown"
    )
}

cut_lang <- function(lang, proj) {
  lang |> when(
    (. == "Python") ~ str_replace(proj, "python-", ""),
    (. == "Go")     ~ str_replace(proj, "go-", ""),
    (. == "C")      ~ str_replace(proj, "c-cmake-", "")
  )
}

rename_mine <- function(proj) {
  proj |> 
    when(
      str_starts(., "readmap") ~ {
        x <- str_split(., "-", n = 2)
        paste0(x[[1]][2], '-mailund')
      },
      ~ proj
    )
}

transform_projects <- function(data) {
  data |>
    mutate(
      Tool = str_to_lower(Tool) |> str_replace_all("\\.", "-") |> str_replace("project-5-",""),
      Tool = map_chr(Tool, rename_mine),
      Language = map_chr(Tool, lang),
      Tool = map2_chr(Language, Tool, cut_lang) |> str_to_title() |> str_replace_all("-", " "),
      Language = fct_relevel(Language, "Python", "Go", "C"),
    ) 
}

```

# Readmapper performance report

This is an autogenerated report of the current performance of readmappers that pass the Github Actions tests.

## Status of projects

```{r, results='asis'}
status <- read.table('../status.txt', header = TRUE) |>
  transform(Project = str_replace(Project, "project-5-","")) |>
  mutate(Language = map_chr(Project, lang)) |>
  transform(Team = map2_chr(Language, Project, cut_lang)) |>
  select(Team, Language, Status)
knitr::kable(status, "pipe")
```

## Preprocessing performance

```{r read_perf}
pre_perf <- read.csv("../preprocessing.txt", header = TRUE) |>
  pivot_longer(-(Chromosomes:Chromosome.length), 
               names_to = "Tool", values_to = "Time") |>
  transform_projects()
pre_perf
```

```{r plot_perf}
pre_perf |> 
  mutate(TL = str_c(Tool, '/', Language)) |>
  group_by(TL) |> 
  mutate(meanTime = mean(Time), TL = fct_reorder(TL, desc(meanTime))) |>
  mutate(TL = fct_reorder(TL, desc(meanTime))) |>
  ggplot(aes(x = TL, y = Time, colour = Language, fill = Language)) +
  geom_violin() +
  facet_grid(. ~ Language, scales = "free_x", space = "free_x") +
  xlab("") +
  theme_classic() +
  scale_fill_brewer(palette="Set2") +
  scale_colour_brewer(palette="Set2") +
  theme(legend.position="bottom")
```

## Mapping performance

```{r read_map}
map_perf <- read.csv("../mapping.txt", header = TRUE) |>
  pivot_longer(-(Chromosomes:Edits), names_to = "Tool", values_to = "Time") |>
  transform_projects()

map_perf
```
